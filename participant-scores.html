<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>استعلام النقاط</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet" />
  <style>
    body { font-family: Cairo, sans-serif; background: #f4f4f4; }
    .container { max-width: 450px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 10px #0001; padding: 30px 18px; }
    h2 { text-align:center; }
    label { display: block; margin-top: 12px; font-weight: bold;}
    input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-top: 5px;}
    button { padding: 8px 16px; margin-top: 10px; border-radius:8px; border:none; background:#004aad; color:white; font-weight:bold; cursor:pointer;}
    .score-table {width:100%; border-collapse:collapse; margin-top:22px;}
    .score-table th, .score-table td {border:1px solid #ddd;padding:8px;text-align:center;}
    .score-table th {background:#e3f2fd;}
    .msg { text-align: center; margin-top: 12px; color: green; }
    .error { color: red; text-align: center; margin-top: 10px;}
    .back-home {text-align:right; margin: 15px 0;}
    .back-home a {
      background:#007bff;color:white;padding:8px 18px;text-decoration:none;border-radius:8px;font-weight:bold;
      display:inline-block;
    }
    .back-home a:hover {background:#0056b3;}
  </style>
</head>
<body>
  <div class="container">
    <div class="back-home">
      <a href="index.html">🏠 الرئيسية</a>
    </div>
    <h2>استعلم عن نقاطك</h2>
    <form id="queryForm">
      <label>رقم المشارك:</label>
      <input type="text" id="participantNumberInput" required placeholder="مثال: KZ-20250614-123456">
      <button type="submit">استعلام</button>
    </form>
    <div id="scoresResult"></div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBic0WV6onX8hafXI09_6N-HUdNiAMJJS0",
      authDomain: "kenz-camp.firebaseapp.com",
      projectId: "kenz-camp",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.getElementById('queryForm').onsubmit = async function(e) {
      e.preventDefault();
      const partNum = document.getElementById("participantNumberInput").value.trim();
      const scoresDiv = document.getElementById("scoresResult");
      scoresDiv.innerHTML = "جارٍ التحميل...";

      // جلب اسم المشارك والتأكد من وجوده
      let pName = "";
      let foundParticipant = false;
      const pSnap = await getDocs(collection(db, "participants"));
      pSnap.forEach(docSnap => {
        const d = docSnap.data();
        if (d.participantNumber === partNum) {
          pName = d.name;
          foundParticipant = true;
        }
      });
      if (!foundParticipant) {
        scoresDiv.innerHTML = `<div class="error">رقم المشارك غير صحيح أو غير مسجل.</div>`;
        return;
      }

      // جلب كل المسابقات
      const contestsQ = await getDocs(collection(db, "contests"));
      const contestArr = [];
      contestsQ.forEach(docSnap => {
        const d = docSnap.data();
        // تأكد أن participants مصفوفة فعلاً
        if (Array.isArray(d.participants) && d.participants.includes(partNum)) {
          contestArr.push({ id: docSnap.id, ...d });
        }
      });

      if (!contestArr.length) {
        scoresDiv.innerHTML = `<div class="msg">لا توجد مسابقات أنت مشترك بها حتى الآن.</div>`;
        return;
      }

      // جلب النقاط لكل مسابقة بدقة
      let html = `<div style="margin-bottom:8px;text-align:center;font-weight:bold;">${pName ? "الاسم: " + pName : ""}</div>
      <table class="score-table">
        <thead>
          <tr>
            <th>المسابقة</th>
            <th>الفترة</th>
            <th>النقاط الكلية</th>
            <th>نقاطك</th>
          </tr>
        </thead>
        <tbody>
      `;
      for (const c of contestArr) {
        let score = "-";
        try {
          const scoreDoc = await getDoc(doc(db, "contestScores", c.id));
          if (scoreDoc.exists() && scoreDoc.data().scores && scoreDoc.data().scores[partNum] !== undefined) {
            score = scoreDoc.data().scores[partNum];
          } else {
            score = "لم تسجل نقاط بعد";
          }
        } catch (e) {
          score = "-";
        }
        html += `<tr>
          <td>${c.name}</td>
          <td>${c.startDate} - ${c.endDate}</td>
          <td>${c.requiredPoints}</td>
          <td>${score}</td>
        </tr>`;
      }
      html += "</tbody></table>";
      scoresDiv.innerHTML = html;
    };
  </script>
</body>
</html>