<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù - Ù…Ø®ÙŠÙ… ÙƒÙ†Ø²</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Cairo, sans-serif;
      background: #f4f4f4;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      /* Ù…Ù‡Ù…: Ù…Ø³Ø§Ø­Ø© Ù„Ù„ÙÙˆØªØ± Ø­ØªÙ‰ Ù„Ø§ ÙŠØºØ·ÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
      padding-bottom: 60px;
    }
    header {
      text-align: center;
      padding: 38px 10px 16px 10px;
      background: linear-gradient(90deg, #1976d2 40%, #ffd54f 110%);
      box-shadow: 0 2px 16px #0001;
      border-radius: 0 0 24px 24px;
      position: relative;
      z-index: 1;
    }
    header h1 {
      margin: 0 0 2px 0;
      font-size: 2.2em;
      color: #fff;
      font-weight: 900;
      letter-spacing: 2px;
      text-shadow: 0 1px 6px #fff5, 0 1px 0 #ffd54f88;
    }
    header h2 {
      margin: 10px 0 0;
      font-size: 1.35em;
      color: #ff9800;
      font-weight: 700;
      text-shadow: 0 1px 4px #1976d299;
      letter-spacing: 1px;
    }
    .nav {
      display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 10px;
      max-width: 700px; margin: 16px auto 16px auto;
    }
    .nav a {
      background-color: #007bff; color: white; padding: 10px; text-align: center;
      border-radius: 8px; text-decoration: none; font-size: 14px; min-width: 120px;
      transition: background 0.2s;
    }
    .nav a#adminLink { background-color: #8e24aa; }
    .nav a#contestsLink { background-color: #1e88e5; }
    .nav a#scoresLink { background-color: #43a047; }
    .nav a#loginLink { background-color: #ff9800; color: #fff; font-weight: bold; }
    .nav a#logoutLink { background-color: #d32f2f; }
    .nav a#honorLink { background-color: #ff9800; color:#004aad; font-weight:bold;}
    .nav a:hover { background-color: #0056b3; }
    .nav a#adminLink:hover { background-color: #5e1972; }
    .nav a#contestsLink:hover { background-color: #1565c0; }
    .nav a#scoresLink:hover { background-color: #1b5e20; }
    .nav a#loginLink:hover { background-color: #e65100; }
    .nav a#logoutLink:hover { background-color: #b71c1c; }
    .nav a#honorLink:hover { background-color: #e65100; color:#fff;}
    .container {max-width:1000px;margin:30px auto 18px;background:#fff;border-radius:12px;box-shadow:0 2px 10px #0001;padding:30px 16px;}
    h2 {text-align:center;}
    table {width:100%;border-collapse:collapse;background:#fff;}
    th,td {padding:10px 8px;border-bottom:1px solid #ddd;text-align:center;font-size:15px;}
    th {background:#e3f2fd;}
    tr.top-row {background:#ffe082!important;font-weight:bold;}
    tr:nth-child(even) {background:#f9f9f9;}
    .back-home {text-align:right; margin: 15px 0;}
    .back-home a {
      background:#007bff;color:white;padding:8px 18px;text-decoration:none;border-radius:8px;font-weight:bold;
      display:inline-block;
    }
    .back-home a:hover {background:#0056b3;}
    .medal {font-size:22px;}
    .group {font-size:15px;color:#1e88e5;}
    .participant-number {font-weight:bold;color:#e53935;}
    .honor-btn-bar {
      text-align: center;
      margin: 20px 0;
      display: flex;
      justify-content: center;
    }
    .honor-btn-bar button {
      background:#ff9800; color:#004aad; font-weight:bold; font-size:20px;
      border:none; border-radius:12px; padding:18px 70px; cursor:pointer;
      transition:background 0.2s;
      box-shadow: 0 2px 8px #0002;
      margin: 0 auto;
      display: block;
      min-width: 300px;
      max-width: 90vw;
    }
    .honor-btn-bar button:hover { background:#e65100; color:#fff; }
    #honorTableWrap {margin-top:20px;}
    .msg {text-align:center; color:#d32f2f; font-size:17px; margin:30px 0;}
    footer {
      background: linear-gradient(90deg,#e3f2fd 70%, #ffd54f 100%);
      font-size: 9px;
      color: #004aad;
      font-family: 'Cairo', sans-serif;
      text-align: center;
      padding: 14px 10px 11px 10px;
      border-radius: 0 0 16px 16px;
      width: 100%;
      margin: 0;
      box-shadow: 0 -1px 14px #ffd54f44;
      letter-spacing: 1px;
      z-index: 10;
      /* ØªØ«Ø¨ÙŠØª Ø§Ù„ÙÙˆØªØ± ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
      position: fixed;
      left: 0; right: 0; bottom: 0;
    }
    @media (max-width: 600px) {
      .container { max-width: 99vw; margin: 10px auto; padding: 10px 2vw; }
      table { font-size: 13px; }
      .back-home a { font-size: 13px; padding: 7px 9px; }
      .honor-btn-bar button {
        font-size: 16px;
        padding: 13px 0;
        min-width: 90vw;
        border-radius: 10px;
      }
      footer { font-size: 10px; padding: 10px 3px 8px 3px; }
      body { padding-bottom: 60px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Ù…Ø®ÙŠÙ… ÙƒÙ†Ø² Ø§Ù„ØµÙŠÙÙŠ</h1>
    <h2>ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù ğŸ†</h2>
  </header>
  <div class="nav">
    <a href="participants.html" id="adminLink" style="display:none">ğŸ‘¥ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</a>
    <a href="admin-contests.html" id="contestsLink" style="display:none">ğŸ† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</a>
    <a href="admin-scores.html" id="scoresLink" style="display:none">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø·</a>
    <a href="honor-board.html" id="honorLink" style="display:none">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</a>
    <a href="participant-scores.html" id="queryScoresLink">ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù†Ù‚Ø§Ø·</a>
    <a href="schedule.html">ğŸ“… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ</a>
    <a href="login.html" id="loginLink">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</a>
    <a href="#" id="logoutLink" class="logout-btn" style="display:none" onclick="adminLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
  </div>
  <div class="container">
    <div class="back-home">
      <a href="index.html">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>
    <div class="honor-btn-bar" id="honorBtnBar">
      <button id="showHonorBtn">Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</button>
    </div>
    <div id="honorTableWrap"></div>
    <div class="msg" id="msgBox" style="display:none"></div>
  </div>
  <footer>
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025 Genius Tech Co
  </footer>
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBic0WV6onX8hafXI09_6N-HUdNiAMJJS0",
      authDomain: "kenz-camp.firebaseapp.com",
      projectId: "kenz-camp",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // NAV & AUTH
    function handleNavDisplay(user) {
      var logoutEl = document.getElementById("logoutLink");
      if (user) {
        document.getElementById("adminLink").style.display = "inline-block";
        document.getElementById("contestsLink").style.display = "inline-block";
        document.getElementById("scoresLink").style.display = "inline-block";
        document.getElementById("honorLink").style.display = "inline-block";
        if (logoutEl) logoutEl.style.display = "inline-block";
        document.getElementById("loginLink").style.display = "none";
      } else {
        document.getElementById("adminLink").style.display = "none";
        document.getElementById("contestsLink").style.display = "none";
        document.getElementById("scoresLink").style.display = "none";
        document.getElementById("honorLink").style.display = "none";
        if (logoutEl) logoutEl.style.display = "none";
        document.getElementById("loginLink").style.display = "inline-block";
      }
    }
    onAuthStateChanged(auth, handleNavDisplay);

    window.adminLogout = function() {
      signOut(auth).then(() => { window.location.href = "login.html"; });
    }
    window.addEventListener('DOMContentLoaded', () => {
      handleNavDisplay(auth.currentUser);
    });

    // Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù
    const honorBtn = document.getElementById("showHonorBtn");
    const honorBtnBar = document.getElementById("honorBtnBar");
    const honorTableWrap = document.getElementById("honorTableWrap");
    const msgBox = document.getElementById("msgBox");

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    async function buildHonorBoard() {
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±
      honorBtnBar.style.display = "none";
      msgBox.style.display = "none";
      honorTableWrap.innerHTML = "<div style='text-align:center;margin:40px 0;font-size:19px;'>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>";

      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª
      const contestsSnap = await getDocs(collection(db, "contests"));
      let contests = [];
      contestsSnap.forEach(docSnap => {
        contests.push({ id: docSnap.id, name: docSnap.data().name || docSnap.id });
      });
      if (!contests.length) {
        honorTableWrap.innerHTML = "";
        msgBox.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ù„Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§.";
        msgBox.style.display = "block";
        return;
      }

      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
      const participantsSnap = await getDocs(collection(db, "participants"));
      let participants = [];
      let participantsMap = {};
      participantsSnap.forEach(docSnap => {
        let d = docSnap.data();
        participants.push(d);
        participantsMap[d.participantNumber] = d;
      });
      if (!participants.length) {
        honorTableWrap.innerHTML = "";
        msgBox.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø¨Ø¹Ø¯.";
        msgBox.style.display = "block";
        return;
      }

      // Ø¬Ù„Ø¨ Ù†ØªØ§Ø¦Ø¬ ÙƒÙ„ Ù…Ø³Ø§Ø¨Ù‚Ø©
      let scoresPerContest = {}; // contestId => { participantNumber: score }
      for (const c of contests) {
        const scoreSnap = await getDoc(doc(db, "contestScores", c.id));
        scoresPerContest[c.id] = (scoreSnap.exists() && scoreSnap.data().scores) ? scoreSnap.data().scores : {};
      }

      // Ø¨Ù†Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·
      let rows = participants.map(p => {
        let total = 0;
        let contestScores = {};
        contests.forEach(c => {
          let val = scoresPerContest[c.id][p.participantNumber];
          contestScores[c.id] = (typeof val === "number") ? val : 0;
          total += contestScores[c.id];
        });
        return {
          participantNumber: p.participantNumber,
          name: p.name || "",
          age: p.age || "",
          group: p.group || "",
          guardian: p.guardian || "",
          contestScores,
          totalPoints: total
        }
      });

      // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
      rows.sort((a, b) => b.totalPoints - a.totalPoints);

      // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¹Ù…Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³Ù…)
      let thead = `<thead><tr>
        <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ø¹Ù…Ø±</th>
        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</th>
        <th>Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©</th>
        <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>`;
      contests.forEach(c => {
        thead += `<th>${c.name}</th>`;
      });
      thead += `<th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead>`;

      let tbody = "<tbody>";
      rows.forEach((row, idx) => {
        tbody += `<tr class="${idx<3?'top-row':''}">
          <td>${idx+1}</td>
          <td>${row.name}</td>
          <td>${row.age}</td>
          <td class="participant-number">${row.participantNumber}</td>
          <td class="group">${row.group}</td>
          <td>${row.guardian}</td>`;
        contests.forEach(c => {
          tbody += `<td>${row.contestScores[c.id]}</td>`;
        });
        tbody += `<td><b>${row.totalPoints}</b></td>
        </tr>`;
      });
      tbody += "</tbody>";

      honorTableWrap.innerHTML = `<h2>Ù„ÙˆØ­Ø© Ø´Ø±Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h2>
        <div style="overflow-x:auto">
          <table>${thead}${tbody}</table>
        </div>
      `;
    }

    // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ†
    honorBtn.onclick = async function() {
      let user = auth.currentUser;
      if (!user) {
        msgBox.textContent = "ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø´Ø±Ù Ù„Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù.";
        msgBox.style.display = "block";
        return;
      }
      await buildHonorBoard();
    };
  </script>
</body>
</html>
