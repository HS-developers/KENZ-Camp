<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة الشرف - مخيم كنز</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet" />
  <style>
    body { font-family: Cairo, sans-serif; background: #f4f4f4; margin:0;}
    header, footer {
      text-align: center;
      padding: 12px 10px;
      background-color: #e3f2fd;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      position: relative;
    }
    header h1 {margin:0;font-size:28px;color:#004aad;}
    header h2 {margin:8px 0 0;font-size:22px;color:#ff9800;}
    .back-home {text-align:right; margin: 15px 0;}
    .back-home a {
      background:#007bff;color:white;padding:8px 18px;text-decoration:none;border-radius:8px;font-weight:bold;
      display:inline-block;
    }
    .back-home a:hover {background:#0056b3;}
    .container {max-width: 900px; margin: 20px auto 0; background: #fff; border-radius: 12px; box-shadow: 0 2px 10px #0001; padding: 30px 18px;}
    h2 {text-align:center;}
    .filter-bar {text-align:right;margin-bottom:13px;}
    .filter-bar label {font-weight:bold;}
    .filter-bar select {padding:6px 14px; border-radius:7px; border:1px solid #bbb; font-family:Cairo,sans-serif;}
    table {width:100%;border-collapse:collapse;margin-top:10px;}
    th,td {padding:12px 8px;border-bottom:1px solid #ddd;text-align:center;}
    th {background-color: #f0f0f0;}
    tr:hover {background-color: #f9f9f9;}
    .rank-badge {background:#004aad;color:white;border-radius:50%;display:inline-block;width:30px;height:30px;line-height:30px;text-align:center;font-weight:bold;}
    .nav {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      max-width: 600px;
      margin: 16px auto 16px auto;
    }
    .nav a {
      background-color: #007bff;
      color: white;
      padding: 10px;
      text-align: center;
      border-radius: 8px;
      text-decoration: none;
      font-size: 14px;
      min-width: 120px;
      transition: background 0.2s;
    }
    .nav a#adminLink {background-color: #8e24aa;}
    .nav a#contestsLink {background-color: #1e88e5;}
    .nav a#scoresLink {background-color: #43a047;}
    .nav a#loginLink {background-color: #ff9800;color:#fff;font-weight:bold;}
    .nav a#logoutLink {background-color: #d32f2f;}
    .nav a#honorLink {background-color: #ff9800; color:#004aad; font-weight:bold;}
    .nav a:hover {background-color: #0056b3;}
    .nav a#adminLink:hover {background-color: #5e1972;}
    .nav a#contestsLink:hover {background-color: #1565c0;}
    .nav a#scoresLink:hover {background-color: #1b5e20;}
    .nav a#loginLink:hover {background-color: #e65100;}
    .nav a#logoutLink:hover {background-color: #b71c1c;}
    .nav a#honorLink:hover {background-color: #e65100; color:#fff;}
    footer {font-size:14px;color:#555;padding:6px 10px;}
    @media (max-width:650px) {
      .container {padding:10px 2px;}
      th,td {font-size:13px;}
      .filter-bar {font-size:14px;}
    }
  </style>
</head>
<body>
  <header>
    <h1>مخيم كمبوند كنز الصيفي</h1>
    <h2>🎖️ لوحة الشرف 🎖️</h2>
  </header>
  <div class="nav">
    <a href="participants.html" id="adminLink" style="display:none">👥 عرض المشاركين</a>
    <a href="admin-contests.html" id="contestsLink" style="display:none">🏆 إدارة المسابقات</a>
    <a href="admin-scores.html" id="scoresLink" style="display:none">📝 تسجيل النقاط</a>
    <a href="honor-board.html" id="honorLink" style="display:none">🏆 لوحة الشرف</a>
    <a href="participant-scores.html" id="queryScoresLink">🔍 استعلام عن النقاط</a>
    <a href="schedule.html">📅 الجدول الزمني</a>
    <a href="points.html">🏅 نظام النقاط</a>
    <a href="login.html" id="loginLink">دخول المشرفين</a>
    <a href="#" id="logoutLink" style="display:none">تسجيل الخروج</a>
  </div>
  <div class="container">
    <div class="back-home">
      <a href="index.html">🏠 الرئيسية</a>
    </div>
    <h2>لوحة الشرف - أعلى النقاط</h2>
    <div class="filter-bar">
      <label for="groupFilter">فلتر الفئة العمرية:</label>
      <select id="groupFilter">
        <option value="all">الكل</option>
        <option value="10-12">10-12 سنة</option>
        <option value="13-15">13-15 سنة</option>
        <option value="16-18">16-18 سنة</option>
      </select>
    </div>
    <table>
      <thead>
        <tr>
          <th>الترتيب</th>
          <th>اسم المشارك</th>
          <th>رقم المشارك</th>
          <th>رقم الوحدة</th>
          <th>العمر</th>
          <th>الفئة العمرية</th>
          <th>مجموع النقاط</th>
        </tr>
      </thead>
      <tbody id="honorBody">
        <tr><td colspan="7">جارٍ التحميل...</td></tr>
      </tbody>
    </table>
  </div>
  <footer>
    All Right Reserved © 2025 Genius Tech Co
  </footer>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBic0WV6onX8hafXI09_6N-HUdNiAMJJS0",
      authDomain: "kenz-camp.firebaseapp.com",
      projectId: "kenz-camp",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // التحكم في ظهور أزرار الإدارة
    function handleNavDisplay(user) {
      if (user) {
        document.getElementById("adminLink").style.display = "inline-block";
        document.getElementById("contestsLink").style.display = "inline-block";
        document.getElementById("scoresLink").style.display = "inline-block";
        document.getElementById("honorLink").style.display = "inline-block";
        document.getElementById("logoutLink").style.display = "inline-block";
        document.getElementById("loginLink").style.display = "none";
      } else {
        document.getElementById("adminLink").style.display = "none";
        document.getElementById("contestsLink").style.display = "none";
        document.getElementById("scoresLink").style.display = "none";
        document.getElementById("honorLink").style.display = "none";
        document.getElementById("logoutLink").style.display = "none";
        document.getElementById("loginLink").style.display = "inline-block";
      }
    }
    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "login.html";
      else handleNavDisplay(user);
    });
    document.getElementById("logoutLink").onclick = (e) => {
      e.preventDefault();
      signOut(auth);
    };

    // حساب وتجميع النقاط لكل مشارك
    async function loadHonorBoard() {
      const honorTbody = document.getElementById("honorBody");
      honorTbody.innerHTML = `<tr><td colspan="7">جارٍ التحميل...</td></tr>`;
      // جلب المشاركين
      const participantsSnap = await getDocs(collection(db, "participants"));
      const participants = {};
      participantsSnap.forEach(docSnap => {
        const d = docSnap.data();
        if (!d.participantNumber) return;
        participants[d.participantNumber] = {
          name: d.name,
          number: d.participantNumber,
          guardian: d.guardian,
          age: d.age,
          group: d.group,
          total: 0
        };
      });
      if (!Object.keys(participants).length) {
        honorTbody.innerHTML = `<tr><td colspan="7">لا يوجد مشاركون</td></tr>`;
        return;
      }
      // جلب كل المسابقات
      const contestsSnap = await getDocs(collection(db, "contests"));
      const contestIds = [];
      contestsSnap.forEach(docSnap => contestIds.push(docSnap.id));
      // جلب النقاط من contestScores
      for (const contestId of contestIds) {
        const scoreDoc = await getDoc(doc(db, "contestScores", contestId));
        if (scoreDoc.exists() && scoreDoc.data().scores) {
          const scores = scoreDoc.data().scores;
          for (const partNum in scores) {
            if (participants[partNum]) {
              participants[partNum].total += parseInt(scores[partNum] || 0);
            }
          }
        }
      }
      // حولهم لمصفوفة ورتبهم
      let participantsArr = Object.values(participants);
      // ترتيب تنازلي بالنقاط، ثم أبجدي للأسماء في حال التساوي
      participantsArr.sort((a, b) => b.total - a.total || a.name.localeCompare(b.name, 'ar'));
      // حفظ النسخة الأصلية للفلترة
      window._allHonorRows = participantsArr;
      renderHonorRows(participantsArr);
    }
    function renderHonorRows(arr) {
      const honorTbody = document.getElementById("honorBody");
      if (!arr.length) {
        honorTbody.innerHTML = `<tr><td colspan="7">لا يوجد نتائج لعرضها</td></tr>`;
        return;
      }
      let html = "";
      let rank = 1;
      arr.forEach(part => {
        html += `
        <tr>
          <td><span class="rank-badge">${rank++}</span></td>
          <td>${part.name}</td>
          <td>${part.number}</td>
          <td>${part.guardian}</td>
          <td>${part.age}</td>
          <td>${part.group}</td>
          <td style="font-weight:bold;color:#004aad;">${part.total}</td>
        </tr>`;
      });
      honorTbody.innerHTML = html;
    }
    // فلترة حسب الفئة العمرية
    document.getElementById("groupFilter").addEventListener("change", function() {
      let arr = window._allHonorRows || [];
      const value = this.value;
      if (value !== "all") {
        arr = arr.filter(p => p.group === value);
      }
      renderHonorRows(arr);
    });

    window.addEventListener("DOMContentLoaded", loadHonorBoard);
  </script>
</body>
</html>